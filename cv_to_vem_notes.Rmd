---
title: "CVλ¥Ό λ„μ–΄ VEMμΌλ΅: μ»¤λ„ λ°€λ„ μ¶”μ •μ μ›λ¦¬μ™€ μ™„μ „ μλ™ν™”"
author: "tae"
date: "`r format(Sys.Date())`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
    code_folding: hide
    theme: united
fontsize: 11pt
geometry: margin=1in
always_allow_html: true
---

```{r setup, include=FALSE}
# R μ²­ν¬μ μ „μ—­ μµμ…μ„ μ„¤μ •ν•©λ‹λ‹¤.
knitr::opts_chunk$set(
  echo = TRUE,      # μ½”λ“λ¥Ό μ¶λ ¥μ— ν¬ν•¨
  message = FALSE,  # λ©”μ‹μ§€ μ¶λ ¥ μ• ν•¨
  warning = FALSE,  # κ²½κ³  μ¶λ ¥ μ• ν•¨
  fig.align = "center", # κ·Έλ¦Όμ„ μ¤‘μ•™ μ •λ ¬
  fig.width = 8,
  fig.height = 5,
  dpi = 200,        # κ·Έλ¦Ό ν•΄μƒλ„
  dev = "png"       # κ·Έλν”½ μ¥μΉ
)
# μ¬ν„μ„±μ„ μ„ν•΄ μ‹λ“ μ„¤μ •
set.seed(123)
```

# 1. μ„λ΅ : μ™ μλ™ν™”λ λ°€λ„ μ¶”μ •μ΄ μ¤‘μ”ν•κ°€?

λ°μ΄ν„°μ κΈ°μ €μ— μλ” ν™•λ¥  λ°€λ„ ν•¨μλ¥Ό μ¶”μ •ν•λ” κ²ƒμ€ λ¨Έμ‹ λ¬λ‹μ ν•µμ‹¬ κ³Όμ μ…λ‹λ‹¤. μ΄λ” **μ΄μƒμΉ νƒμ§€**(λ¶„ν¬μ—μ„ λ²—μ–΄λ‚ λ°μ΄ν„°λ¥Ό μ°Ύλ” κ²ƒ), **μƒμ„± λ¨λΈ**(μƒλ΅μ΄ λ°μ΄ν„°λ¥Ό λ§λ“¤μ–΄λ‚΄λ” κ²ƒ), **λ°μ΄ν„° μ‹κ°ν™”** λ“± λ‹¤μ–‘ν• λ¶„μ•Όμ— ν™μ©λ©λ‹λ‹¤. **μ»¤λ„ λ°€λ„ μ¶”μ •(Kernel Density Estimation, KDE)**, νΉν **μ»¤λ„ μ§€μμ΅±(Kernel Exponential Family, KEF)** λ¨λΈμ€ λ³µμ΅ν• λ¶„ν¬λ¥Ό μ μ—°ν•κ² λ¨λΈλ§ν•  μ μλ” κ°•λ ¥ν• λ„κµ¬μ…λ‹λ‹¤.

ν•μ§€λ§ μ΄ κ°•λ ¥ν•¨μ—λ” λ€κ°€κ°€ λ”°λ¦…λ‹λ‹¤. λ°”λ΅ **ν•μ΄νΌνλΌλ―Έν„° νλ‹**μ λ¬Έμ μ…λ‹λ‹¤.

* **Οƒ (μ‹κ·Έλ§):** μ»¤λ„μ **λ€μ—­ν­(bandwidth)**μΌλ΅, λ¨λΈμ΄ μ–Όλ§λ‚ 'λ¶€λ“λ¬μ΄' λ¶„ν¬λ¥Ό ν•™μµν• μ§€ κ²°μ •ν•©λ‹λ‹¤. λ„λ¬΄ μ‘μΌλ©΄ κ³Όμ ν•©λκ³ , λ„λ¬΄ ν¬λ©΄ κ³Όν•κ² λ‹¨μν™”λ©λ‹λ‹¤.
* **Ξ» (λλ‹¤):** **μ •κ·ν™”(regularization)** κ°•λ„λ΅, λ¨λΈμ λ³µμ΅λ„λ¥Ό μ μ–΄ν•μ—¬ κ³Όμ ν•©μ„ λ°©μ§€ν•©λ‹λ‹¤.

μ „ν†µμ μΌλ΅ μ΄λ¬ν• νλΌλ―Έν„°λ“¤μ€ **κµμ°¨ κ²€μ¦(Cross-Validation, CV)**μ„ ν†µν•΄ νƒμƒ‰ν•©λ‹λ‹¤. ν•μ§€λ§ μ΄λ” νλΌλ―Έν„°λ“¤μ λ¨λ“  μ΅°ν•©μ— λ€ν•΄ λ¨λΈμ„ μμ‹­, μλ°± λ²μ”© μ¬ν•™μµν•΄μ•Ό ν•λ”, μ—„μ²­λ‚ κ³„μ‚° λΉ„μ©μ„ μ”κµ¬ν•λ” κ³ λ μ‘μ—…μ…λ‹λ‹¤. π«

**μ΄ κ°•μ λ…ΈνΈμ λ©ν‘λ”** μ΄ κ³ λ CV κ³Όμ •μ„ **λ³€λ¶„ κΈ°λ“κ°’-μµλ€ν™”(Variational EM, VEM)**λΌλ” ν›¨μ”¬ λ” μ§€λ¥μ μ΄κ³  ν¨μ¨μ μΈ ν”„λ μ„μ›ν¬λ΅ μ™„μ „ν λ€μ²΄ν•λ” λ°©λ²•μ„ λ°°μ°λ” κ²ƒμ…λ‹λ‹¤. VEMμ„ ν†µν•΄ **Οƒμ™€ Ξ» κ°™μ€ ν•µμ‹¬ ν•μ΄νΌνλΌλ―Έν„°λ“¤μ„ λ°μ΄ν„°λ΅λ¶€ν„° μλ™μΌλ΅ ν•™μµ**μ‹μΌ, μ „μ²΄ νλ‹ κ³Όμ •μ„ ν•λ‚μ ν†µν•©λ μµμ ν™” λ¬Έμ λ΅ ν’€μ–΄λ‚΄λ” μ—¬μ •μ„ ν•¨κ» λ– λ‚λ³΄κ² μµλ‹λ‹¤.

---

# 2. μ΄λ΅ μ  λ°°κ²½: μ¤μ½”μ–΄ λ§¤μΉ­κ³Ό λ² μ΄μ§€μ• ν”„λ μ„μ›ν¬

### 2.1. μ¤μ½”μ–΄ λ§¤μΉ­: λ‹¤λ£¨κΈ° νλ“  μ λ¶„ λ¬Έμ μ μ°ν

KEF λ¨λΈμ λ΅κ·Έ λ°€λ„λ” \( \log p_\theta(x) = f_\theta(x) - A(\theta) \) μ…λ‹λ‹¤. μ—¬κΈ°μ„ \( f_\theta(x) = \mathbf{w}^\top \bm{\phi}_\sigma(x) \) μ΄κ³ , \( A(\theta) \)λ” λ΅κ·Έ μ •κ·ν™” μƒμμ…λ‹λ‹¤. μ΄ \( A(\theta) = \log \int \exp(f_\theta(x)) dx \) ν•­μ€ μ „μ²΄ λ°μ΄ν„° κ³µκ°„μ— λ€ν• μ λ¶„μ„ ν¬ν•¨ν•κΈ° λ•λ¬Έμ— κ³„μ‚°μ΄ κ±°μ λ¶κ°€λ¥ν•©λ‹λ‹¤.

**μ¤μ½”μ–΄ λ§¤μΉ­(Score Matching)**μ€ μ΄ λ¬Έμ λ¥Ό μ°νν•λ” κΈ°λ²•μ…λ‹λ‹¤. "λ°€λ„ ν•¨μ μμ²΄λ¥Ό λ§μ¶”κΈ° μ–΄λ µλ‹¤λ©΄, λ°€λ„ ν•¨μμ **κΈ°μΈκΈ°(gradient)**λΌλ„ λ§μ¶”μ!"λ” μ•„μ΄λ””μ–΄μ…λ‹λ‹¤.  λ°μ΄ν„° λ¶„ν¬μ 'μ¤μ½”μ–΄'(\( \nabla_x \log p(x) \))μ™€ λ¨λΈμ μ¤μ½”μ–΄(\( \nabla_x \log p_\theta(x) \)) μ‚¬μ΄μ μ°¨μ΄λ¥Ό μµμ†ν™”ν•λ” λ©μ  ν•¨μλ¥Ό μ‚¬μ©ν•λ©°, λ†€λκ²λ„ μ΄ κ³Όμ •μ—μ„ λ‹¤λ£¨κΈ° νλ“  \( A(\theta) \)κ°€ μ‚¬λΌμ§‘λ‹λ‹¤.

μµμΆ…μ μΌλ΅ μ°λ¦¬κ°€ μµμ†ν™”ν•  μ¤μ½”μ–΄ λ§¤μΉ­ λ©μ  ν•¨μλ” κ°€μ¤‘μΉ `w`μ— λ€ν• **μ΄μ°¨μ‹(Quadratic form)**μ΄ λ©λ‹λ‹¤.
$$
J(\mathbf{w};\sigma) = \frac12 \mathbf{w}^\top K_\sigma \mathbf{w} - \mathbf{b}_\sigma^\top \mathbf{w} + \text{μƒμ}
$$
μ΄ 'μ΄μ°¨μ‹'μ΄λΌλ” νΉμ„±μ΄ VEM μ•κ³ λ¦¬μ¦ μ μ©μ μ—΄μ‡ κ°€ λ©λ‹λ‹¤.

### 2.2. λ² μ΄μ§€μ• λ¨λΈλ§: νλΌλ―Έν„°λ¥Ό ν™•λ¥  λ³€μλ΅ λ³΄κΈ°

μ΄μ  κ΄€μ μ„ μ „ν™ν•μ—¬, μ΄ λ¬Έμ λ¥Ό λ² μ΄μ§€μ• ν”„λ μ„μ›ν¬μ—μ„ λ°”λΌλ³΄κ² μµλ‹λ‹¤.

* **κ°€λ¥λ„ (Likelihood):** μ¤μ½”μ–΄ λ§¤μΉ­ λ©μ  ν•¨μλ¥Ό **μμ λ΅κ·Έ κ°€λ¥λ„**λ΅ κ°„μ£Όν•©λ‹λ‹¤. μ¦‰, \( J(\mathbf{w};\sigma) \)κ°€ μ‘μ„μλ΅ λ°μ΄ν„°κ°€ λ‚νƒ€λ‚  ν™•λ¥ μ΄ λ†’λ‹¤κ³  λ³΄λ” κ²ƒμ…λ‹λ‹¤.
    $$p(D \mid \mathbf{w}, \sigma, \beta) \propto \exp( -\beta J(\mathbf{w};\sigma) )$$
    - `Ξ²`λ” λ¨λΈμ μμΈ΅(μ¤μ½”μ–΄)μ„ μ–Όλ§λ‚ μ‹ λΆ°ν• μ§€λ¥Ό λ‚νƒ€λ‚΄λ” **μ •λ°€λ„(precision)** νλΌλ―Έν„°μ…λ‹λ‹¤.

* **μ‚¬μ „ λ¶„ν¬ (Prior):** λ¨λΈμ΄ λ„λ¬΄ λ³µμ΅ν•΄μ§€λ” κ²ƒμ„ λ§‰κΈ° μ„ν•΄ κ°€μ¤‘μΉ `w`μ— λ€ν• μ‚¬μ „ λ―Ώμμ„ μ„¤μ •ν•©λ‹λ‹¤. `w`μ κ°’λ“¤μ΄ 0μ— κ°€κΉμΈ κ²ƒμ΄λΌλ” κ°€μ •μ„ ν•λ” κ²ƒμ€ μ „ν†µμ μΈ L2 μ •κ·ν™”(Ridge)μ™€ λ™μΌν• ν¨κ³Όλ¥Ό μ¤λ‹λ‹¤.
    $$p(\mathbf{w} \mid \tau) = \mathcal{N}(\mathbf{w} \mid \mathbf{0}, \tau^2 I)$$
    - `Ο„Β²`λ” κ°€μ¤‘μΉκ°€ 0μ—μ„ μ–Όλ§λ‚ νΌμ Έλ„ λλ”μ§€λ¥Ό λ‚νƒ€λ‚΄λ” **λ¶„μ‚°**μ…λ‹λ‹¤. `1/Ο„Β²`κ°€ λ°”λ΅ μ°λ¦¬κ°€ νλ‹ν•λ μ •κ·ν™” κ°•λ„ `Ξ»`μ— ν•΄λ‹Ήν•©λ‹λ‹¤. **`Ο„`κ°€ μ‘μ„μλ΅ κ°•ν• μ •κ·ν™”**λ¥Ό μλ―Έν•©λ‹λ‹¤.

### 2.3. μ¦κ±° ν•ν• (ELBO): μ°λ¦¬μ μµμΆ… λ©ν‘ ν•¨μ

μ°λ¦¬κ°€ μ§„μ§ μµλ€ν™”ν•κ³  μ‹¶μ€ κ²ƒμ€ **λ¨λΈ μ¦κ±°(Model Evidence)**, \( p(D | \sigma, \tau, \beta) \) μ…λ‹λ‹¤. μ΄λ” μ£Όμ–΄μ§„ ν•μ΄νΌνλΌλ―Έν„° ν•μ—μ„ λ°μ΄ν„°κ°€ λ‚νƒ€λ‚  μ΄ ν™•λ¥ λ΅, μ΄ κ°’μ΄ λ†’μ€ ν•μ΄νΌνλΌλ―Έν„°κ°€ κ°€μ¥ μΆ‹μ€ κ²ƒμ…λ‹λ‹¤. ν•μ§€λ§ μ΄ λν• μ§μ ‘ κ³„μ‚°μ΄ μ–΄λ µμµλ‹λ‹¤.

κ·Έλμ„ μ°λ¦¬λ” κ·Έ **ν•ν•(Lower Bound)**μΈ **μ¦κ±° ν•ν•(ELBO)**μ„ λ€μ‹  μµλ€ν™”ν•©λ‹λ‹¤. ELBOλ¥Ό μµλ€ν™”ν•λ©΄ μ‹¤μ  λ¨λΈ μ¦κ±°λ„ ν•¨κ» μ¦κ°€ν•λ” ν¨κ³Όκ°€ μμµλ‹λ‹¤. VEMμ€ λ°”λ΅ μ΄ ELBOλ¥Ό μµλ€ν™”ν•λ” μ•κ³ λ¦¬μ¦μ…λ‹λ‹¤.

$$
\mathcal{L}(\mathbf{m}, S, \sigma, \beta, \tau) = \underbrace{\mathbb{E}_q[\log p(D \mid \mathbf{w}, \sigma, \beta)]}_{\text{λ°μ΄ν„° μ ν•©λ„}} + \underbrace{\mathbb{E}_q[\log p(\mathbf{w} \mid \tau)] - \mathbb{E}_q[\log q(\mathbf{w})]}_{\text{λ¨λΈ λ³µμ΅λ„ μ μ–΄ (μ •κ·ν™”)}}
$$
μ—¬κΈ°μ„ \( q(\mathbf{w}) = \mathcal{N}(\mathbf{w} \mid \mathbf{m}, S) \)λ” μ°λ¦¬κ°€ λ‹¤λ£¨κΈ° νλ“  μ‹¤μ  μ‚¬ν›„ λ¶„ν¬ \( p(\mathbf{w}|D) \)λ¥Ό κ·Όμ‚¬ν•κΈ° μ„ν•΄ λ„μ…ν• κ°„λ‹¨ν• κ°€μ°μ‹μ• λ¶„ν¬μ…λ‹λ‹¤.

---

# 3. VEM μ•κ³ λ¦¬μ¦: E-λ‹¨κ³„μ™€ M-λ‹¨κ³„μ λ„μ¤ π•Ίπ’ƒ

VEMμ€ ELBOλ¥Ό μµλ€ν™”ν•κΈ° μ„ν•΄ **E(Expectation) λ‹¨κ³„**μ™€ **M(Maximization) λ‹¨κ³„**λ¥Ό λ²κ°μ•„ μν–‰ν•©λ‹λ‹¤. μ΄λ” λ§μΉ λ‘ λ…μ λ„μ„κ°€ μ„λ΅μ—κ² λ§μ¶°κ°€λ©° μ¶¤μ„ μ™„μ„±ν•λ” κ²ƒκ³Ό κ°™μµλ‹λ‹¤.

### 3.1. E-λ‹¨κ³„: κ°€μ¤‘μΉ(w)μ— λ€ν• λ―Ώμ μ—…λ°μ΄νΈ

**"ν„μ¬ ν•μ΄νΌνλΌλ―Έν„°(Οƒ, Ο„, Ξ²)κ°€ μ£Όμ–΄μ΅μ„ λ•, κ°€μ¤‘μΉ wλ” μ–΄λ–¤ λ¶„ν¬λ¥Ό λ”°λ¥΄λ” κ²ƒμ΄ κ°€μ¥ ν•©λ¦¬μ μΌκΉ?"**

μ΄ λ‹¨κ³„μ—μ„λ” ν•μ΄νΌνλΌλ―Έν„°λ¥Ό μƒμλ΅ κ³ μ •ν•κ³ , ELBOλ¥Ό μµλ€ν™”ν•λ” λ³€λ¶„ νλΌλ―Έν„° `m` (κ°€μ¤‘μΉμ ν‰κ· )κ³Ό `S` (κ°€μ¤‘μΉμ κ³µλ¶„μ‚°)λ¥Ό μ°Ύμµλ‹λ‹¤. μ΄λ” κ·Όμ‚¬ λ¶„ν¬ `q(w)`κ°€ μ‹¤μ  μ‚¬ν›„ λ¶„ν¬μ— κ°€μ¥ κ°€κΉμ›μ§€λ„λ΅ μ—…λ°μ΄νΈν•λ” κ³Όμ •μ…λ‹λ‹¤.

* **S (κ³µλ¶„μ‚°) μ—…λ°μ΄νΈ:**
    $$S \leftarrow (\beta K_\sigma + \tau^{-2} I)^{-1}$$
* **m (ν‰κ· ) μ—…λ°μ΄νΈ:**
    $$\mathbf{m} \leftarrow \beta S \mathbf{b}_\sigma$$

### 3.2. M-λ‹¨κ³„: ν•μ΄νΌνλΌλ―Έν„° μµμ ν™”

**"λ°©κΈ κ³„μ‚°ν• κ°€μ¤‘μΉ λ¶„ν¬ `q(w)`λ¥Ό κ³ λ ¤ν•  λ•, μ΄ λ°μ΄ν„°λ¥Ό κ°€μ¥ μ μ„¤λ…ν•λ” ν•μ΄νΌνλΌλ―Έν„°(Οƒ, Ο„, Ξ²)λ” λ¬΄μ—‡μΌκΉ?"**

μ΄ λ‹¨κ³„μ—μ„λ” λ°λ€λ΅ `m`κ³Ό `S`λ¥Ό μƒμλ΅ κ³ μ •ν•κ³ , ELBOλ¥Ό μµλ€ν™”ν•λ” ν•μ΄νΌνλΌλ―Έν„°λ¥Ό μ°Ύμµλ‹λ‹¤.

* **Ο„ (μ •κ·ν™”) μ—…λ°μ΄νΈ:** `Ο„Β²`λ” κ°€μ¤‘μΉμ ν‰κ·  μ κ³± ν¬κΈ°(`(tr(S) + ||m||Β²)/M`)λ΅ μ—…λ°μ΄νΈλ©λ‹λ‹¤. μ¦‰, **λ°μ΄ν„°λ¥Ό ν†µν•΄ λ¨λΈμ— ν•„μ”ν• μµμ μ μ •κ·ν™” κ°•λ„λ¥Ό λ§¤ λ‹¨κ³„λ§λ‹¤ μλ™μΌλ΅ κ²°μ •**ν•©λ‹λ‹¤.
    $$ \tau^2 \leftarrow \frac{\mathrm{tr}(S) + \|\mathbf{m}\|^2}{M} $$

* **Ξ² (μ •λ°€λ„) μ—…λ°μ΄νΈ:** `Ξ²`λ” ν„μ¬ λ¨λΈμ μμΈ΅ μ¤μ°¨(μ¤μ½”μ–΄ λ§¤μΉ­ μ†μ‹¤)μ— λ°λΉ„λ΅€ν•λ„λ΅ μ—…λ°μ΄νΈλ©λ‹λ‹¤. λ¨λΈμ΄ λ°μ΄ν„°λ¥Ό μ μ„¤λ…ν•λ©΄ `Ξ²`κ°€ μ»¤μ§€κ³ , κ·Έλ ‡μ§€ μ•μΌλ©΄ μ‘μ•„μ§‘λ‹λ‹¤.
    $$ \beta \leftarrow \frac{2 \cdot \mathbf{b}_\sigma^\top \mathbf{m}}{\mathrm{tr}(K_\sigma S) + \mathbf{m}^\top K_\sigma \mathbf{m}} $$

* **Οƒ (μ»¤λ„ λ€μ—­ν­) μ—…λ°μ΄νΈ:** `Οƒ`λ” λ‹«ν ν•΄κ°€ μ—†μΌλ―€λ΅ **κ²½μ‚¬ μƒμΉλ²•(Gradient Ascent)**μ„ μ‚¬μ©ν•©λ‹λ‹¤. ELBOλ¥Ό `Οƒ`μ— λ€ν•΄ λ―Έλ¶„ν•μ—¬, ELBOκ°€ κ°€μ¥ κ°€νλ¥΄κ² μ¦κ°€ν•λ” λ°©ν–¥μΌλ΅ `Οƒ`λ¥Ό μ΅°κΈμ”© μ—…λ°μ΄νΈν•©λ‹λ‹¤.
    $$ \sigma \leftarrow \sigma + \eta_\sigma \frac{\partial \mathcal{L}}{\partial \sigma} $$

μ΄ λ‘ λ‹¨κ³„λ¥Ό λ°λ³µν•λ©΄, νλΌλ―Έν„°λ“¤μ€ μ μ°¨ μ•μ •λ κ°’μΌλ΅ μλ ΄ν•κ³  ELBOλ” κΎΈμ¤€ν μ¦κ°€ν•κ² λ©λ‹λ‹¤.

---

# 4. R κµ¬ν„: VEM μ•κ³ λ¦¬μ¦ μ‹¤μ „ μ½”λ”©

### 4.1. λ°μ΄ν„° μƒμ„±

λ¨Όμ €, VEM μ•κ³ λ¦¬μ¦μ„ ν…μ¤νΈν•  2μ°¨μ› κ°€μ°μ‹μ• νΌν•© λ°μ΄ν„°λ¥Ό μƒμ„±ν•©λ‹λ‹¤.

```{r simulate-2d}
library(mvtnorm)
library(ggplot2)
library(gridExtra)

n  <- 200 # κ³„μ‚° μ†λ„λ¥Ό μ„ν•΄ μƒν” μ μ΅°μ •
pi <- c(0.55, 0.45)
mu <- list(c(-1, -0.5), c(2, 1.2))
S1 <- matrix(c(0.6, 0.3, 0.3, 0.8), 2, 2)
S2 <- matrix(c(0.5, -0.2, -0.2, 0.5), 2, 2)
z  <- rbinom(n, size = 1, prob = pi[2]) + 1
X_data <- matrix(NA, n, 2)
X_data[z==1,] <- rmvnorm(sum(z==1), mean = mu[[1]], sigma = S1)
X_data[z==2,] <- rmvnorm(sum(z==2), mean = mu[[2]], sigma = S2)
dat <- data.frame(x1 = X_data[,1], x2 = X_data[,2])

# μ΄κΈ° λ°μ΄ν„° λ¶„ν¬ ν™•μΈ
ggplot(dat, aes(x1, x2)) +
  geom_point(alpha = 0.8, size = 1.5, aes(color = as.factor(z))) +
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha = 0.2) +
  scale_fill_viridis_c() +
  scale_color_brewer(palette = "Set1") +
  coord_equal() +
  labs(title = "μƒμ„±λ 2D λ°μ΄ν„° λ° μ‹¤μ  λ¶„ν¬", x = "x1", y = "x2", color = "μ‹¤μ  ν΄λ¬μ¤ν„°") +
  theme_bw(base_size = 12) + theme(legend.position = "bottom")
```

### 4.2. μ»¤λ„ λ° λ―Έλ¶„ ν•¨μ μ •μ

VEM μ•κ³ λ¦¬μ¦μ κ° λ‹¨κ³„μ— ν•„μ”ν• κ°€μ°μ‹μ• RBF μ»¤λ„κ³Ό κ·Έ λ„ν•¨μλ“¤μ„ R ν•¨μλ΅ μ •μν•©λ‹λ‹¤.

```{r kernel-functions}
# κ°€μ°μ‹μ• RBF μ»¤λ„ ν•¨μ
rbf_kernel <- function(x, y, sigma) {
  exp(-sum((x - y)^2) / (2 * sigma^2))
}

# μ»¤λ„μ xμ— λ€ν• κ·Έλλ””μ–ΈνΈ (λ²΅ν„° λ°ν™)
grad_x_rbf <- function(x, y, sigma) {
  -rbf_kernel(x, y, sigma) * (x - y) / sigma^2
}

# μ»¤λ„μ xμ— λ€ν• λΌν”λΌμ‹μ• (μ¤μΉΌλΌ λ°ν™)
lap_x_rbf <- function(x, y, sigma) {
  sq_dist <- sum((x - y)^2)
  d <- length(x)
  rbf_kernel(x, y, sigma) * (sq_dist / sigma^4 - d / sigma^2)
}

# --- M-λ‹¨κ³„μ sigma μ—…λ°μ΄νΈλ¥Ό μ„ν• ν•¨μλ“¤ ---

# μ»¤λ„μ sigmaμ— λ€ν• κ·Έλλ””μ–ΈνΈ
grad_sigma_rbf <- function(x, y, sigma) {
  rbf_kernel(x, y, sigma) * sum((x-y)^2) / sigma^3
}

# μ»¤λ„ κ·Έλλ””μ–ΈνΈ(grad_x_rbf)μ sigmaμ— λ€ν• κ·Έλλ””μ–ΈνΈ
grad_sigma_grad_x_rbf <- function(x, y, sigma) {
  term1 <- grad_sigma_rbf(x, y, sigma) * (-(x-y)/sigma^2)
  term2 <- rbf_kernel(x, y, sigma) * (2*(x-y)/sigma^3)
  return(term1 + term2)
}

# μ»¤λ„ λΌν”λΌμ‹μ•(lap_x_rbf)μ sigmaμ— λ€ν• κ·Έλλ””μ–ΈνΈ
grad_sigma_lap_x_rbf <- function(x, y, sigma) {
  sq_dist <- sum((x - y)^2)
  d <- length(x)
  term1 <- grad_sigma_rbf(x,y,sigma) * (sq_dist / sigma^4 - d/sigma^2)
  term2 <- rbf_kernel(x,y,sigma) * (-4*sq_dist/sigma^5 + 2*d/sigma^3)
  return(term1 + term2)
}
```

### 4.3. VEM μ•κ³ λ¦¬μ¦ κµ¬ν„: ν•µμ‹¬ λ£¨ν”„

μ¤λ¥λ¥Ό μμ •ν• `compute_Kb` ν•¨μμ™€ μ „μ²΄ VEM μ•κ³ λ¦¬μ¦ λ£¨ν”„μ…λ‹λ‹¤. κ° λ‹¨κ³„μ— μƒμ„Έν• μ£Όμ„μ„ μ¶”κ°€ν•μ—¬ μ½”λ“μ νλ¦„μ„ μ‰½κ² λ”°λΌκ° μ μλ„λ΅ ν–μµλ‹λ‹¤.

```{r vem-implementation-fixed}
# K_sigma μ™€ b_sigma λ° κ·Έ λ„ν•¨μλ“¤μ„ κ³„μ‚°ν•λ” ν•¨μ
compute_derivatives <- function(X, basis, sigma) {
  n <- nrow(X)
  M <- nrow(basis)
  D <- ncol(X)
  
  # κ²°κ³Όλ¥Ό μ €μ¥ν•  ν–‰λ ¬λ“¤ μ΄κΈ°ν™”
  K_sigma <- matrix(0, M, M)
  b_sigma <- numeric(M)
  dK_dsigma <- matrix(0, M, M) # K_sigmaμ sigmaμ— λ€ν• λ„ν•¨μ
  db_dsigma <- numeric(M)   # b_sigmaμ sigmaμ— λ€ν• λ„ν•¨μ
  
  # κ° λ°μ΄ν„° ν¬μΈνΈμ— λ€ν•΄ λ£¨ν”„
  for (i in 1:n) {
    # ν„ λ°μ΄ν„° ν¬μΈνΈ x_iμ— λ€ν• Jacobian λ° κ·Έ λ„ν•¨μ κ³„μ‚°
    J_i <- matrix(0, D, M)         # J_i(j,k) = d(phi_k(x_i))/d(x_j)
    dJ_dsigma_i <- matrix(0, D, M) # d(J_i)/d(sigma)
    H_i_row <- numeric(M)          # λΌν”λΌμ‹μ• κ°’λ“¤
    dH_dsigma_i_row <- numeric(M)  # λΌν”λΌμ‹μ•μ sigma λ„ν•¨μ κ°’λ“¤
    
    for (j in 1:M) {
      J_i[, j] <- grad_x_rbf(X[i, ], basis[j, ], sigma)
      dJ_dsigma_i[, j] <- grad_sigma_grad_x_rbf(X[i, ], basis[j, ], sigma)
      H_i_row[j] <- lap_x_rbf(X[i, ], basis[j, ], sigma)
      dH_dsigma_i_row[j] <- grad_sigma_lap_x_rbf(X[i, ], basis[j, ], sigma)
    }
    
    # K_sigma μ™€ b_sigma μ—…λ°μ΄νΈ (μ¤λ¥ μμ •λ λ¶€λ¶„)
    # J_iλ” D x M ν–‰λ ¬, t(J_i)λ” M x D ν–‰λ ¬. t(J_i) %*% J_i λ” M x M ν–‰λ ¬μ΄ λ¨.
    K_sigma <- K_sigma + t(J_i) %*% J_i
    b_sigma <- b_sigma - H_i_row
    
    # λ„ν•¨μ ν–‰λ ¬ μ—…λ°μ΄νΈ (Product Rule μ μ©)
    dK_dsigma <- dK_dsigma + (t(dJ_dsigma_i) %*% J_i + t(J_i) %*% dJ_dsigma_i)
    db_dsigma <- db_dsigma - dH_dsigma_i_row
  }
  
  # μƒν” μ nμΌλ΅ λ‚λ„μ–΄ ν‰κ·  κ³„μ‚°
  return(list(
    K = K_sigma / n,
    b = b_sigma / n,
    dK_dsigma = dK_dsigma / n,
    db_dsigma = db_dsigma / n
  ))
}


# VEM μ•κ³ λ¦¬μ¦ μ£Ό ν•¨μ
run_vem <- function(X_data, basis_pts, n_iters = 50, lr_sigma = 0.01) {
  
  M <- nrow(basis_pts)
  
  # 1. ν•μ΄νΌνλΌλ―Έν„° μ΄κΈ°ν™”
  sigma <- 1.0
  tau2 <- 1.0 # tauμ μ κ³±μΌλ΅ κ΄€λ¦¬
  beta <- 1.0
  
  history <- data.frame(iter = 1:n_iters, elbo = NA, sigma = NA, tau = NA, beta = NA)
  
  cat("VEM μ•κ³ λ¦¬μ¦ μ‹μ‘...\n")
  for (iter in 1:n_iters) {
    # --- M-λ‹¨κ³„ μ¤€λΉ„: ν•„μ”ν• λ¨λ“  λ„ν•¨μ κ³„μ‚° ---
    derivs <- compute_derivatives(X_data, basis_pts, sigma)
    K_sigma <- derivs$K
    b_sigma <- derivs$b
    
    # --- E-λ‹¨κ³„: m, S μ—…λ°μ΄νΈ ---
    S <- solve(beta * K_sigma + (1/tau2) * diag(M))
    m <- beta * S %*% b_sigma
    
    # --- M-λ‹¨κ³„: ν•μ΄νΌνλΌλ―Έν„° μ—…λ°μ΄νΈ ---
    
    # 1. tau μ—…λ°μ΄νΈ (μ •κ·ν™” κ°•λ„ μλ™ μ΅°μ )
    tau2 <- (sum(diag(S)) + sum(m^2)) / M
    
    # 2. beta μ—…λ°μ΄νΈ (λ¨λΈ μ‹ λΆ°λ„ μλ™ μ΅°μ )
    numerator <- 2 * t(b_sigma) %*% m
    denominator <- sum(diag(K_sigma %*% S)) + t(m) %*% K_sigma %*% m
    beta <- as.numeric(numerator / denominator)
    
    # 3. sigma μ—…λ°μ΄νΈ (κ²½μ‚¬ μƒμΉλ²•)
    # ELBOμ sigmaμ— λ€ν• κ·Έλλ””μ–ΈνΈ κ³„μ‚°
    grad_L_sigma <- -0.5 * beta * (sum(diag(derivs$dK_dsigma %*% S)) + t(m) %*% derivs$dK_dsigma %*% m) +
                    beta * t(derivs$db_dsigma) %*% m
    
    sigma <- sigma + lr_sigma * grad_L_sigma
    sigma <- max(sigma, 0.01) # sigmaκ°€ μμκ°€ λμ§€ μ•λ„λ΅ λ°©μ§€
    
    # --- λ¨λ‹ν„°λ§: ELBO κ³„μ‚° ---
    log_det_S <- determinant(S, logarithm = TRUE)$modulus[1]
    elbo <- -0.5*beta*(sum(diag(K_sigma %*% S)) + t(m)%*%K_sigma%*%m) + 
            beta * t(b_sigma)%*%m - 
            0.5/tau2 * (sum(diag(S)) + sum(m^2)) + 0.5*log_det_S
    
    history[iter, ] <- c(iter, elbo, sigma, sqrt(tau2), beta)
    if (iter %% 10 == 0) cat(sprintf("  Iter %d: ELBO=%.2f, sigma=%.3f, tau=%.3f\n", iter, elbo, sigma, sqrt(tau2)))
  }
  cat("VEM μ•κ³ λ¦¬μ¦ μΆ…λ£.\n")
  
  return(list(m = m, S = S, final_params = c(sigma, sqrt(tau2), beta), history = history))
}

# κΈ°μ €μ (basis points)μΌλ΅ λ°μ΄ν„° ν¬μΈνΈλ¥Ό κ·Έλ€λ΅ μ‚¬μ©
basis_pts <- X_data
# VEM μ‹¤ν–‰
vem_results <- run_vem(X_data, basis_pts, n_iters = 40, lr_sigma = 0.001)

# μµμΆ… ν•™μµλ ν•μ΄νΌνλΌλ―Έν„° μ¶λ ¥
print("μµμΆ… ν•μ΄νΌνλΌλ―Έν„° (sigma, tau, beta):")
print(vem_results$final_params)
```

### 4.4. κ²°κ³Ό μ‹κ°ν™” λ° μ‹¬μΈµ λ¶„μ„

VEM μ•κ³ λ¦¬μ¦μ΄ ν•μ΄νΌνλΌλ―Έν„°λ“¤μ„ μ–΄λ–»κ² ν•™μµν–κ³ , κ·Έ κ²°κ³Όλ΅ μ–»μ–΄μ§„ λ°€λ„ μ¶”μ •μ΄ μ–΄λ–¤ λ¨μµμΈμ§€ μ‹κ°μ μΌλ΅ λ¶„μ„ν•΄ λ³΄κ² μµλ‹λ‹¤.

```{r visualize-results}
# 1. ν•μ΄νΌνλΌλ―Έν„° λ° ELBO μλ ΄ κ³Όμ • μ‹κ°ν™”
history <- vem_results$history
p1 <- ggplot(history, aes(x = iter, y = sigma)) + geom_line(color="blue") + geom_point(color="blue") + labs(title = "Sigma (μ»¤λ„ λ€μ—­ν­) μλ ΄ κ³Όμ •", y = "sigma") + theme_bw()
p2 <- ggplot(history, aes(x = iter, y = tau)) + geom_line(color="red") + geom_point(color="red") + labs(title = "Tau (μ •κ·ν™”) μλ ΄ κ³Όμ •", y = "tau") + theme_bw()
p3 <- ggplot(history, aes(x = iter, y = elbo)) + geom_line(color="darkgreen") + geom_point(color="darkgreen") + labs(title = "ELBO (λ©ν‘ ν•¨μ) μλ ΄ κ³Όμ •", y = "ELBO") + theme_bw()

grid.arrange(p1, p2, p3, ncol = 3)

# 2. μµμΆ… μ¶”μ •λ λ°€λ„ ν”λ΅―
# ν‰κ°€μ© κ·Έλ¦¬λ“ μƒμ„±
grid_range <- apply(X_data, 2, function(x) range(x) + c(-1, 1))
x1_grid <- seq(grid_range[1,1], grid_range[2,1], length.out = 80)
x2_grid <- seq(grid_range[1,2], grid_range[2,2], length.out = 80)
eval_grid <- expand.grid(x1 = x1_grid, x2 = x2_grid)

# κ·Έλ¦¬λ“ κ° μ μ—μ„ f(x) κ°’ κ³„μ‚° (λ΅κ·Έ λ°€λ„μ— λΉ„λ΅€)
final_m <- vem_results$m
final_sigma <- vem_results$final_params[1]
log_density_vals <- apply(eval_grid, 1, function(x_eval) {
  phi_x <- sapply(1:nrow(basis_pts), function(j) rbf_kernel(x_eval, basis_pts[j,], final_sigma))
  sum(final_m * phi_x)
})

eval_grid$log_density <- log_density_vals

# μµμΆ… λ°€λ„ μ‹κ°ν™”
ggplot() +
  stat_contour(data = eval_grid, aes(x = x1, y = x2, z = log_density, fill = ..level..), geom = "polygon", alpha=0.8) +
  geom_point(data = dat, aes(x = x1, y = x2), alpha = 0.7, size = 1.5, shape=3, color="white") +
  scale_fill_viridis_c(option = "plasma") +
  coord_equal(xlim = grid_range[,1], ylim = grid_range[,2]) +
  labs(title = "VEMμ„ ν†µν•΄ μµμΆ…μ μΌλ΅ ν•™μµλ λ°€λ„",
       subtitle = paste("μµμΆ… sigma =", round(final_sigma, 3), " / μµμΆ… tau =", round(vem_results$final_params[2], 3)),
       x = "x1", y = "x2", fill = "λ΅κ·Έ λ°€λ„") +
  theme_minimal(base_size = 14)

```

---

# 5. κ²°λ΅ : λ‘λ‘ν• μλ™ν™”μ ν π§ β¨

μ΄ κ°•μ λ…ΈνΈλ¥Ό ν†µν•΄ μ°λ¦¬λ” VEM μ•κ³ λ¦¬μ¦μ μ›λ¦¬λ¥Ό κΉμ΄ μ΄ν•΄ν•κ³ , μ‹¤μ  μ½”λ“λ΅ κµ¬ν„ν•μ—¬ κ·Έ κ°•λ ¥ν•¨μ„ ν™•μΈν–μµλ‹λ‹¤.

1.  **μ™„μ „ν• μλ™ν™”μ μ‹¤ν„:** μ°λ¦¬λ” `sigma`(μ»¤λ„ λ€μ—­ν­), `tau`(μ •κ·ν™” κ°•λ„)μ™€ κ°™μ€ ν•µμ‹¬ ν•μ΄νΌνλΌλ―Έν„°λ“¤μ„ **κµμ°¨ κ²€μ¦ μ—†μ΄**, λ‹¨μΌ μµμ ν™” λ£¨ν”„ λ‚΄μ—μ„ λ°μ΄ν„°λ΅λ¶€ν„° μ§μ ‘ ν•™μµν–μµλ‹λ‹¤. μλ ΄ κ³Όμ • κ·Έλν”„λ” κ° νλΌλ―Έν„°κ°€ ELBOλ¥Ό μµλ€ν™”ν•λ” λ°©ν–¥μΌλ΅ μ•μ •μ μΈ κ°’μ— λ„λ‹¬ν–μμ„ λ…ν™•ν λ³΄μ—¬μ¤λ‹λ‹¤.

2.  **μ΄λ΅ κ³Ό μ‹¤μ μ μ™„λ²½ν• μ—°κ²°:** M-λ‹¨κ³„μ—μ„ μ λ„λ λ¶„μ„μ μΈ μ—…λ°μ΄νΈ κ·μΉ™κ³Ό κ²½μ‚¬ μƒμΉλ²•μ΄ μ‹¤μ  μ½”λ“μ— μ–΄λ–»κ² μ μ©λλ”μ§€, νΉν μ¤λ¥λ¥Ό μμ •ν•κ³  λ„ν•¨μλ¥Ό μ •ν™•ν κ³„μ‚°ν•λ” κ³Όμ •μ„ ν†µν•΄ λ…ν™•ν μ΄ν•΄ν•  μ μμ—μµλ‹λ‹¤.

3.  **κ²°κ³Όμ νƒ€λ‹Ήμ„± λ° ν•΄μ„:** μµμΆ…μ μΌλ΅ μ¶”μ •λ λ°€λ„ ν”λ΅―μ€ μ΄κΈ° λ°μ΄ν„°μ μ΄μ¤‘ λ΄‰μ°λ¦¬(bimodal) λ¶„ν¬λ¥Ό μ„±κ³µμ μΌλ΅ ν¬μ°©ν–μµλ‹λ‹¤. μ΄λ” VEMμ΄ λ³µμ΅ν• ν•μ΄νΌνλΌλ―Έν„° κ³µκ°„μ„ ν¨κ³Όμ μΌλ΅ νƒμƒ‰ν•μ—¬ νƒ€λ‹Ήν• λ¨λΈμ„ μ°Ύμ•„λƒμμ„ μλ―Έν•©λ‹λ‹¤. μµμΆ…μ μΌλ΅ ν•™μµλ `sigma`μ™€ `tau` κ°’μ€ μ΄ λ°μ΄ν„°μ…‹μ— μ ν•©ν• 'λ¶€λ“λ¬μ›€'κ³Ό 'λ³µμ΅λ„'λ¥Ό VEM μ¤μ¤λ΅ μ°Ύμ•„λƒμμ„ λ³΄μ—¬μ¤λ‹λ‹¤.

κ²°λ΅ μ μΌλ΅, VEMμ€ κµμ°¨ κ²€μ¦μ κ³„μ‚°μ  λΉ„ν¨μ¨μ„±κ³Ό λ²κ±°λ΅μ›€μ„ κ·Ήλ³µν•κ³ , **λ” λΉ λ¥΄κ³ , λ” μ›μΉ™μ— μ…κ°ν• λ°©μ‹**μΌλ΅ λΉ„λ¨μμ  λ°€λ„ μ¶”μ • λ¨λΈμ„ κµ¬μ¶•ν•  μ μλ” κ°•λ ¥ν• λ€μ•μ…λ‹λ‹¤. μ΄ ν”„λ μ„μ›ν¬λ” λ² μ΄μ§€μ• μ¶”λ΅ μ μ¥μ μΈ λ¶ν™•μ‹¤μ„± μ •λ‰ν™”μ™€ μλ™ν™”λ νλΌλ―Έν„° νλ‹μ„ λ™μ‹μ— μ κ³µν•μ—¬, λ°μ΄ν„° κ³Όν•™μμ—κ² λ” κ°•λ ¥ν• λ¬΄κΈ°λ¥Ό μ¥μ—¬μ¤λ‹λ‹¤.